# Interactive Charts in Bufferbane

## Overview

Bufferbane now supports **interactive HTML charts** in addition to static PNG exports. These charts provide hover tooltips, statistics panels, and a professional UI - all in a self-contained HTML file with no external dependencies.

## Why Interactive Charts?

### Advantages over PNG

| Feature | Static PNG | Interactive HTML |
|---------|-----------|------------------|
| **File Size** | ~300KB | ~14KB |
| **Hover Tooltips** | ❌ No | ✅ Yes - exact timestamp & value |
| **Statistics Panel** | ❌ No | ✅ Yes - min/max/avg/P95/P99 |
| **Font Scaling** | Fixed | Scales with browser |
| **Sharing** | Easy | Easy (single file) |
| **Offline Use** | ✅ Yes | ✅ Yes (no external deps) |
| **Print Quality** | ✅ High | Medium |

### When to Use Each Format

**Use PNG when:**
- Creating reports for printing
- Need highest image quality
- Embedding in documents/presentations
- Archival purposes

**Use Interactive HTML when:**
- Investigating specific issues (need exact timestamps)
- Sharing with ISP support (they can explore the data)
- Lightweight storage/email
- Web-based dashboards
- Detailed forensic analysis

---

## Usage

### Basic Interactive Chart

```bash
# Generate interactive HTML chart for last 24 hours
./target/release/bufferbane --chart --interactive
```

Output: `latency_YYYYMMDD_HHMMSS.html`

### With Time Range

```bash
# Last week
./target/release/bufferbane --chart --interactive --last 7d

# Specific period
./target/release/bufferbane --chart --interactive \
  --start "2025-10-18 18:00" \
  --end "2025-10-18 22:00" \
  --output problem_analysis.html
```

### Custom Output Path

```bash
./target/release/bufferbane --chart --interactive --output report.html
```

---

## Interactive Features

### 1. Hover Tooltips

Hover over any data point to see:
- **Target**: Which server was pinged
- **Time**: Full timestamp (date, time, seconds)
- **Latency**: Exact RTT in milliseconds (2 decimal places)

The tooltip follows your mouse and appears automatically within 20 pixels of a data point.

### 2. Statistics Panel

Below the chart, each target gets a card showing:
- **Average latency** (large, prominent)
- **Min/Max values**
- **P95 and P99 percentiles**

These statistics are calculated client-side from the data.

### 3. Visual Design

- **Grid lines**: Light gray for easy reading
- **Axis labels**: Large (14px), dark gray, readable
- **Axis descriptions**: Bold (18px), clear "Time" and "Latency (ms)"
- **Legend**: Color-coded with 24px wide line indicators
- **Color palette**: Professional blues, greens, reds, oranges
- **Responsive canvas**: 1200x600px chart area

### 4. Data Points

- **Line thickness**: 3px for clear visibility
- **Smooth rendering**: HTML5 Canvas for performance
- **Multiple targets**: Each target gets a unique color
- **Time formatting**: Adaptive (HH:MM on axis, full datetime in tooltips)

---

## Technical Implementation

### Technology Stack

- **HTML5 Canvas**: For high-performance chart rendering
- **Pure JavaScript**: No external libraries (no jQuery, no Chart.js, no plotly)
- **Vanilla CSS**: Modern, responsive design
- **Self-contained**: All code embedded in single HTML file

### Architecture

```
┌─────────────────────────────────────────┐
│     HTML File (self-contained)          │
├─────────────────────────────────────────┤
│ 1. CSS Styles                           │
│    - Modern design system               │
│    - Responsive layout                  │
│    - Dark tooltips, light cards         │
├─────────────────────────────────────────┤
│ 2. HTML Structure                       │
│    - Container with padding/shadow      │
│    - Canvas element (1200x600)          │
│    - Tooltip div (positioned absolute)  │
│    - Legend div (flex layout)           │
│    - Stats div (grid layout)            │
├─────────────────────────────────────────┤
│ 3. Data Embedding                       │
│    - JSON object with target -> points  │
│    - Format: {target: [[ts, rtt], ...]} │
│    - Generated by Rust at export time   │
├─────────────────────────────────────────┤
│ 4. JavaScript Engine                    │
│    - drawChart(): Render grid, axes     │
│    - mousemove handler: Tooltip logic   │
│    - calculateStats(): Percentiles      │
│    - formatTime(): Time formatting      │
└─────────────────────────────────────────┘
```

### Data Flow

1. **Rust side** (`client/src/charts/mod.rs`):
   - Queries measurements from SQLite
   - Groups by target
   - Calculates time/value ranges
   - Formats data as JSON string
   - Embeds in HTML template
   - Writes single `.html` file

2. **Browser side** (JavaScript):
   - Parses embedded data object
   - Calculates canvas coordinates
   - Renders grid, axes, labels
   - Draws data lines
   - Handles mouse events for tooltips
   - Generates statistics cards

### Font Sizes (Improved for Readability)

| Element | Size | Weight | Color |
|---------|------|--------|-------|
| Title | 28px | Normal | #333 |
| Axis descriptions | 18px | Bold | #333 |
| Axis labels | 14px | Normal | #666 |
| Legend items | 16px | Normal | Black |
| Stat card label | 12px | Normal | #666 (uppercase) |
| Stat card value | 24px | 600 | #333 |
| Tooltip text | 14px | Normal | White on rgba(0,0,0,0.9) |

### Performance

- **Rendering**: Single-pass Canvas drawing (efficient)
- **Hover detection**: O(n) search over all points (fast for typical datasets)
- **File size**: ~14KB for 100+ data points
- **Load time**: Instant (no external resources)
- **Browser compatibility**: All modern browsers (Chrome, Firefox, Safari, Edge)

---

## Comparison: PNG vs HTML

### Static PNG (Updated with Larger Fonts)

**Font improvements in this update:**
- Title: 30px → 40px
- Axis labels: 12px → 20px
- Axis descriptions: 16px → 24px
- Legend: 14px → 18px
- Label/description areas: Increased to accommodate larger fonts

**PNG generation** (`generate_latency_chart`):
- Uses `plotters` crate with `BitMapBackend`
- Draws min/max/avg/P95/P99 lines
- Shaded area between min/max
- Output: 1920x1080 (or configured size)
- File size: ~300KB

### Interactive HTML

**HTML generation** (`generate_interactive_chart`):
- Custom rendering with Canvas API
- Hover tooltips with exact values
- Statistics panel for each target
- Output: Responsive HTML
- File size: ~14KB (20x smaller!)

---

## Future Enhancements (Possible)

### Phase 2+ Ideas

- **Zoom/Pan**: Allow zooming into specific time ranges
- **Toggle targets**: Click legend to show/hide targets
- **Export to PNG**: Client-side canvas-to-PNG conversion
- **Real-time updates**: WebSocket connection for live data
- **Multiple metrics**: Tabs for latency/jitter/packet loss
- **Dark mode**: Toggle light/dark themes
- **Annotations**: Mark specific incidents on the chart

---

## Example Output

### File Structure

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bufferbane - Latency Chart</title>
    <style>
        /* Modern CSS with card design */
    </style>
</head>
<body>
    <div class="container">
        <h1>Bufferbane - Latency Over Time</h1>
        <p><strong>Period:</strong> 2025-10-18 12:00 to 2025-10-18 13:00</p>
        
        <div class="chart-container">
            <canvas id="chart" width="1200" height="600"></canvas>
            <div id="tooltip"></div>
        </div>
        
        <div class="legend" id="legend"></div>
        <div class="stats" id="stats"></div>
    </div>

    <script>
        const data = {
            "dns.google": [[1729255200, 12.34], ...],
            "1.1.1.1": [[1729255200, 8.56], ...]
        };
        // ... rendering logic ...
    </script>
</body>
</html>
```

### Visual Layout

```
┌────────────────────────────────────────────────┐
│ Bufferbane - Latency Over Time                 │
│ Period: 2025-10-18 12:00 to 2025-10-18 13:00   │
├────────────────────────────────────────────────┤
│                                                │
│  Latency (ms) │                                │
│         30 ─  │          ╱╲                     │
│            │  │       ╱──  ──╲                  │
│         20 ─  │    ╱──        ──╲               │
│            │  │ ╱──              ──╲            │
│         10 ─  │──                   ──          │
│            │  │                                 │
│          0 ─  └─────────────────────────────    │
│               12:00  12:15  12:30  12:45  13:00│
│                        Time                     │
│                                                │
│        [Tooltip on hover shows exact values]   │
├────────────────────────────────────────────────┤
│ Legend: ─ dns.google  ─ 1.1.1.1                │
├────────────────────────────────────────────────┤
│ Statistics:                                    │
│ ┌──────────────┐ ┌──────────────┐              │
│ │ dns.google   │ │ 1.1.1.1      │              │
│ │ 12.45ms      │ │ 8.67ms       │              │
│ │ Min: 10.23ms │ │ Min: 7.89ms  │              │
│ │ Max: 15.67ms │ │ Max: 9.45ms  │              │
│ └──────────────┘ └──────────────┘              │
└────────────────────────────────────────────────┘
```

---

## Code Reference

### Generating Interactive Charts

See `client/src/charts/mod.rs`:
```rust
pub fn generate_interactive_chart(
    measurements: &[Measurement],
    output_path: &Path,
    _config: &Config,
) -> Result<()>
```

### Command-line Flag

See `client/src/main.rs`:
```rust
#[derive(Debug, Parser)]
struct Args {
    // ...
    
    /// Generate interactive HTML chart instead of static PNG
    #[arg(long)]
    interactive: bool,
}
```

---

## Troubleshooting

### Chart not displaying

- **Open in browser**: The file must be opened in a web browser (Chrome, Firefox, Safari, Edge)
- **JavaScript enabled**: Ensure JavaScript is not blocked
- **File integrity**: Check that the file is complete (not truncated)

### Tooltips not working

- **Hover near points**: Tooltips appear within 20 pixels of data points
- **Browser compatibility**: Use a modern browser with Canvas support

### Performance issues

- **Large datasets**: For >10,000 points, consider using PNG instead
- **Browser memory**: Close other tabs if sluggish

### File size concerns

- **HTML is much smaller**: ~14KB vs ~300KB PNG
- **Data volume**: File size scales with number of data points
- **Compression**: HTML compresses well (gzip, zstd)

---

## Summary

Interactive HTML charts provide a lightweight, self-contained way to explore Bufferbane data with hover tooltips and statistics panels. Use them for detailed analysis and sharing, while PNG remains ideal for printing and archival.

**Recommendation**: Use `--interactive` for most analysis tasks, and generate PNG when you need print-quality or archival images.

